<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTOTECH - Intelligent Service</title>

    <!-- CSS -->
    <link rel="stylesheet" href="asset/style.css">

    <!-- Font Awesome Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <div class="login-container">

        <!-- Logo -->
        <div class="logo">
            <h1>OTOTECH</h1>
            <p>Intelligent Service</p>
        </div>

        <!-- Icon xe h∆°i -->
        <div class="car-icon">
            <img src="asset/car-icon.png" alt="Car Icon">
        </div>

        <!-- Ch√†o m·ª´ng -->
        <h2 class="welcome-text">Ch√†o m·ª´ng quay tr·ªü l·∫°i !</h2>

        <!-- Form ƒëƒÉng nh·∫≠p -->
        <form>
            <!-- Name -->
            <div class="form-group">
                <label>T√™n ƒëƒÉng nh·∫≠p</label>
                <div class="input-wrapper">
                    <input type="text" placeholder="Nh·∫≠p t√™n admin" id="admin">
                </div>
            </div>

            <!-- Password -->
            <div class="form-group">
                <label>M·∫≠t kh·∫©u</label>
                <div class="input-wrapper">
                    <input type="password" placeholder="Password" id="password">
                    <i class="fas fa-eye-slash eye-icon" id="togglePassword"></i>
                </div>
            </div>

            <!-- N∆°i ch·ªØa im (ghi nh·ªõ ƒëƒÉng nh·∫≠p) -->
            <div class="remember-wrapper">
                <input type="checkbox" id="remember">
                <label for="remember">Ghi nh·ªõ ƒëƒÉng nh·∫≠p</label>
            </div>

            <!-- Th√¥ng b√°o l·ªói -->
            <div id="error-message" class="error-message" style="display: none;"></div>

            <button type="button" class="login-btn" id="loginBtn" onclick="handleLogin()">
                ƒêƒÇNG NH·∫¨P
            </button>

        </form>
    </div>

    <!-- JS Toggle M·∫≠t kh·∫©u & X·ª≠ l√Ω ƒëƒÉng nh·∫≠p -->
    <!-- API Service -->
    <script src="asset/api.js"></script>
    
    <!-- JS Toggle M·∫≠t kh·∫©u & Login -->
    <script>
        // C·∫•u h√¨nh API endpoint - thay ƒë·ªïi URL n√†y theo backend Node.js c·ªßa b·∫°n
        const API_BASE_URL = 'http://localhost:3000/api'; // Ho·∫∑c URL backend c·ªßa b·∫°n
        const LOGIN_API = `${API_BASE_URL}/admin/login`; // ƒêi·ªÅu ch·ªânh endpoint theo backend

        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');

        togglePassword.addEventListener('click', function () {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);

            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // Ki·ªÉm tra n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p - NH∆ØNG KH√îNG T·ª∞ ƒê·ªòNG REDIRECT
        // ƒê·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ ƒëƒÉng nh·∫≠p l·∫°i n·∫øu c·∫ßn
        // if (AuthService.isAuthenticated()) {
        //     window.location.href = 'dashboard.html';
        // }

        // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
        async function handleLogin() {
            const tenDangNhap = document.getElementById('admin').value.trim();
            const matKhau = document.getElementById('password').value;

            if (!tenDangNhap || !matKhau) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            // X√ìA TOKEN C≈® TR∆Ø·ªöC KHI ƒêƒÇNG NH·∫¨P L·∫†I
            AuthService.removeToken();

            const loginBtn = document.querySelector('.login-btn');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';
            loginBtn.disabled = true;

            console.log('üîê B·∫Øt ƒë·∫ßu ƒëƒÉng nh·∫≠p v·ªõi:', { tenDangNhap, hasPassword: !!matKhau });

            const result = await AuthService.login(tenDangNhap, matKhau);

            console.log('üîê K·∫øt qu·∫£ ƒëƒÉng nh·∫≠p:', result);
            console.log('üîê Ki·ªÉm tra ƒëi·ªÅu ki·ªán:', {
                hasResult: !!result,
                success: result?.success,
                successType: typeof result?.success,
                hasData: !!(result?.data),
                hasToken: !!(result?.data?.token),
                tokenType: typeof result?.data?.token
            });

            // CH·ªà REDIRECT KHI TH·ª∞C S·ª∞ C√ì SUCCESS = TRUE V√Ä C√ì TOKEN
            // Ki·ªÉm tra ch·∫∑t ch·∫Ω t·ª´ng ƒëi·ªÅu ki·ªán
            const canRedirect = (
                result && 
                result.success === true && 
                typeof result.success === 'boolean' &&
                result.data && 
                result.data.token &&
                typeof result.data.token === 'string' &&
                result.data.token.length > 0
            );

            if (canRedirect) {
                console.log('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng, redirect...');
                alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
                window.location.href = 'dashboard.html';
            } else {
                console.error('‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i - KH√îNG REDIRECT:', {
                    result: result,
                    canRedirect: canRedirect,
                    reason: !result ? 'No result' :
                            result.success !== true ? 'Success is not true' :
                            typeof result.success !== 'boolean' ? 'Success is not boolean' :
                            !result.data ? 'No data' :
                            !result.data.token ? 'No token' :
                            typeof result.data.token !== 'string' ? 'Token is not string' :
                            result.data.token.length === 0 ? 'Token is empty' : 'Unknown'
                });
                alert(result?.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i! Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.');
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        }

        // G·∫Øn s·ª± ki·ªán cho n√∫t ƒëƒÉng nh·∫≠p
        document.querySelector('.login-btn').addEventListener('click', handleLogin);

        // Enter ƒë·ªÉ ƒëƒÉng nh·∫≠p
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        function goTo(page) {
            window.location.href = page;
        }

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // H√†m ·∫©n th√¥ng b√°o l·ªói
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        // H√†m x·ª≠ l√Ω ƒëƒÉng nh·∫≠p
        async function handleLogin() {
            const adminInput = document.getElementById('admin');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const rememberCheckbox = document.getElementById('remember');

            const username = adminInput.value.trim();
            const password = passwordInput.value.trim();

            // Ki·ªÉm tra input r·ªóng
            if (!username || !password) {
                showError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u!');
                return;
            }

            // ·∫®n th√¥ng b√°o l·ªói c≈©
            hideError();

            // Disable button v√† hi·ªÉn th·ªã loading
            loginBtn.disabled = true;
            loginBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

            try {
                // G·ªçi API ƒëƒÉng nh·∫≠p
                const response = await fetch(LOGIN_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                // Ki·ªÉm tra n·∫øu response kh√¥ng ph·∫£i JSON
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    // N·∫øu kh√¥ng ph·∫£i JSON, t·∫°o object l·ªói
                    const text = await response.text();
                    data = {
                        error: text || 'L·ªói t·ª´ server',
                        message: response.status === 401 || response.status === 403 
                            ? 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!' 
                            : 'ƒê√£ x·∫£y ra l·ªói khi ƒëƒÉng nh·∫≠p!'
                    };
                }

                // Ki·ªÉm tra response - h·ªó tr·ª£ nhi·ªÅu format API kh√°c nhau
                // Format 1: { success: true, token: "...", message: "..." }
                // Format 2: { status: "success", data: {...} }
                // Format 3: HTTP 200 = th√†nh c√¥ng, HTTP 401/400 = th·∫•t b·∫°i
                const isSuccess = response.ok && (
                    data.success === true || 
                    data.status === 'success' || 
                    (response.status === 200 && !data.error)
                );

                if (isSuccess) {
                    // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
                    
                    // L∆∞u th√¥ng tin ƒëƒÉng nh·∫≠p n·∫øu ch·ªçn "Ghi nh·ªõ"
                    const token = data.token || data.data?.token || 'authenticated';
                    if (rememberCheckbox.checked) {
                        localStorage.setItem('adminToken', token);
                        localStorage.setItem('adminUsername', username);
                    } else {
                        sessionStorage.setItem('adminToken', token);
                        sessionStorage.setItem('adminUsername', username);
                    }

                    // Chuy·ªÉn ƒë·∫øn trang dashboard
                    window.location.href = 'dashboard-layout.html';
                } else {
                    // ƒêƒÉng nh·∫≠p th·∫•t b·∫°i
                    const errorMsg = data.message || 
                                   data.error || 
                                   data.data?.message ||
                                   'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
                    showError(errorMsg);
                    
                    // Reset button
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ƒêƒÇNG NH·∫¨P';
                    
                    // X√≥a m·∫≠t kh·∫©u
                    passwordInput.value = '';
                }
            } catch (error) {
                // X·ª≠ l√Ω l·ªói k·∫øt n·ªëi ho·∫∑c l·ªói kh√°c
                console.error('Login error:', error);
                showError('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi!');
                
                // Reset button
                loginBtn.disabled = false;
                loginBtn.textContent = 'ƒêƒÇNG NH·∫¨P';
            }
        }

        // Cho ph√©p ƒëƒÉng nh·∫≠p b·∫±ng ph√≠m Enter
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('password');
            const adminInput = document.getElementById('admin');

            [adminInput, passwordInput].forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            });
        });
    </script>
</body>
</html>
