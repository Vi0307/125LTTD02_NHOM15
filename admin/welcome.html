<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTOTECH - Intelligent Service</title>

    <!-- CSS -->
    <link rel="stylesheet" href="asset/style.css">

    <!-- Font Awesome Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <div class="login-container">

        <!-- Logo -->
        <div class="logo">
            <h1>OTOTECH</h1>
            <p>Intelligent Service</p>
        </div>

        <!-- Icon xe hÆ¡i -->
        <div class="car-icon">
            <img src="asset/car-icon.png" alt="Car Icon">
        </div>

        <!-- ChÃ o má»«ng -->
        <h2 class="welcome-text">ChÃ o má»«ng quay trá»Ÿ láº¡i !</h2>

        <!-- Form Ä‘Äƒng nháº­p -->
        <form>
            <!-- Name -->
            <div class="form-group">
                <label>TÃªn Ä‘Äƒng nháº­p</label>
                <div class="input-wrapper">
                    <input type="text" placeholder="Nháº­p tÃªn admin" id="admin">
                </div>
            </div>

            <!-- Password -->
            <div class="form-group">
                <label>Máº­t kháº©u</label>
                <div class="input-wrapper">
                    <input type="password" placeholder="Password" id="password">
                    <i class="fas fa-eye-slash eye-icon" id="togglePassword"></i>
                </div>
            </div>

            <!-- NÆ¡i chá»¯a im (ghi nhá»› Ä‘Äƒng nháº­p) -->
            <div class="remember-wrapper">
                <input type="checkbox" id="remember">
                <label for="remember">Ghi nhá»› Ä‘Äƒng nháº­p</label>
            </div>

            <button type="button" class="login-btn" onclick="goTo('dashboard-layout.html')">
                ÄÄ‚NG NHáº¬P
            </button>

        </form>
    </div>

    <!-- API Service -->
    <script src="asset/api.js"></script>
    
    <!-- JS Toggle Máº­t kháº©u & Login -->
    <script>
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');

        togglePassword.addEventListener('click', function () {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);

            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // Kiá»ƒm tra náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p - NHÆ¯NG KHÃ”NG Tá»° Äá»˜NG REDIRECT
        // Äá»ƒ ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ Ä‘Äƒng nháº­p láº¡i náº¿u cáº§n
        // if (AuthService.isAuthenticated()) {
        //     window.location.href = 'dashboard.html';
        // }

        // Xá»­ lÃ½ Ä‘Äƒng nháº­p
        async function handleLogin() {
            const tenDangNhap = document.getElementById('admin').value.trim();
            const matKhau = document.getElementById('password').value;

            if (!tenDangNhap || !matKhau) {
                alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!');
                return;
            }

            // XÃ“A TOKEN CÅ¨ TRÆ¯á»šC KHI ÄÄ‚NG NHáº¬P Láº I
            AuthService.removeToken();

            const loginBtn = document.querySelector('.login-btn');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = 'Äang Ä‘Äƒng nháº­p...';
            loginBtn.disabled = true;

            console.log('ğŸ” Báº¯t Ä‘áº§u Ä‘Äƒng nháº­p vá»›i:', { tenDangNhap, hasPassword: !!matKhau });

            const result = await AuthService.login(tenDangNhap, matKhau);

            console.log('ğŸ” Káº¿t quáº£ Ä‘Äƒng nháº­p:', result);
            console.log('ğŸ” Kiá»ƒm tra Ä‘iá»u kiá»‡n:', {
                hasResult: !!result,
                success: result?.success,
                successType: typeof result?.success,
                hasData: !!(result?.data),
                hasToken: !!(result?.data?.token),
                tokenType: typeof result?.data?.token
            });

            // CHá»ˆ REDIRECT KHI THá»°C Sá»° CÃ“ SUCCESS = TRUE VÃ€ CÃ“ TOKEN
            // Kiá»ƒm tra cháº·t cháº½ tá»«ng Ä‘iá»u kiá»‡n
            const canRedirect = (
                result && 
                result.success === true && 
                typeof result.success === 'boolean' &&
                result.data && 
                result.data.token &&
                typeof result.data.token === 'string' &&
                result.data.token.length > 0
            );

            if (canRedirect) {
                console.log('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng, redirect...');
                alert('ÄÄƒng nháº­p thÃ nh cÃ´ng!');
                window.location.href = 'dashboard.html';
            } else {
                console.error('âŒ ÄÄƒng nháº­p tháº¥t báº¡i - KHÃ”NG REDIRECT:', {
                    result: result,
                    canRedirect: canRedirect,
                    reason: !result ? 'No result' :
                            result.success !== true ? 'Success is not true' :
                            typeof result.success !== 'boolean' ? 'Success is not boolean' :
                            !result.data ? 'No data' :
                            !result.data.token ? 'No token' :
                            typeof result.data.token !== 'string' ? 'Token is not string' :
                            result.data.token.length === 0 ? 'Token is empty' : 'Unknown'
                });
                alert(result?.message || 'ÄÄƒng nháº­p tháº¥t báº¡i! Vui lÃ²ng kiá»ƒm tra láº¡i thÃ´ng tin.');
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        }

        // Gáº¯n sá»± kiá»‡n cho nÃºt Ä‘Äƒng nháº­p
        document.querySelector('.login-btn').addEventListener('click', handleLogin);

        // Enter Ä‘á»ƒ Ä‘Äƒng nháº­p
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        function goTo(page) {
            window.location.href = page;
        }
    </script>
</body>
</html>
