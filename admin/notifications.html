<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTOTECH - Th√¥ng b√°o</title>
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f4ff;
            color: #666;
        }

        .tab-btn:hover {
            background: #e0e8ff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #4e9fff, #007bff);
            color: white;
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Badge ƒë·∫øm */
        .badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 50px;
            font-size: 12px;
            margin-left: 8px;
        }

        .tab-btn.active .badge {
            background: white;
            color: #007bff;
        }

        /* Status badges */
        .status-warning {
            background: #fff3cd;
            color: #856404;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
        }

        /* Info boxes */
        .info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 28px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .info-box i {
            font-size: 32px;
        }

        .info-box-content h3 {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .info-box-content p {
            font-size: 14px;
            opacity: 0.9;
        }

        .info-box.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        /* Notify table specifics */
        .notify-table {
            width: 100%;
            border-collapse: collapse;
        }

        .notify-table th {
            background: #f1f3f5;
            padding: 16px;
            text-align: left;
            font-weight: 600;
        }

        .notify-table td {
            padding: 18px 16px;
            border-bottom: 1px solid #eee;
        }

        .notify-table tr:hover {
            background: #f8fbff;
        }

        /* Action buttons in table */
        .btn-send {
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 8px;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-complete {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-complete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }

        .btn-reset {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        /* Progress bar chu ki bao duong */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 50px;
            overflow: hidden;
            min-width: 100px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 50px;
            transition: width 0.3s;
        }

        .progress-fill.low {
            background: linear-gradient(90deg, #28a745, #34ce57);
        }

        .progress-fill.mid {
            background: linear-gradient(90deg, #ffc107, #ffca2c);
        }

        .progress-fill.high {
            background: linear-gradient(90deg, #dc3545, #f5576c);
        }

        .progress-text {
            font-size: 13px;
            font-weight: 600;
            min-width: 60px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #333;
        }

        /* Cycle info */
        .cycle-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .cycle-info h4 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }

        .cycle-info p {
            font-size: 14px;
            color: #666;
            margin: 4px 0;
        }

        .cycle-info strong {
            color: #007bff;
        }

        /* Description text */
        .desc-text {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        /* Form t·∫°o nh·∫Øc nh·ªü */
        .reminder-form {
            padding: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }

        .reminder-form .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .reminder-form .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .reminder-form .form-group label i {
            margin-right: 6px;
            color: #007bff;
        }

        .form-select,
        .form-input {
            padding: 14px 18px;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-select:focus,
        .form-input:focus {
            outline: none;
            border-color: #4e9fff;
            box-shadow: 0 0 0 4px rgba(78, 159, 255, 0.1);
        }

        .btn-create-reminder {
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-create-reminder:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-create-reminder:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>

<body class="dashboard-body admin-body">

    <div class="page-wrapper">

        <!-- Top User -->
        <div class="top-user">
            <span class="username">Administrator</span>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="menu">
                <li class="menu-item" onclick="goTo('dashboard.html')">
                    <i class="fas fa-th-large"></i> S·∫£n ph·∫©m
                </li>
                <li class="menu-item" onclick="goTo('user.html')">
                    <i class="fas fa-users"></i> Ng∆∞·ªùi d√πng
                </li>
                <li class="menu-item" onclick="goTo('order.html')">
                    <i class="fas fa-shopping-cart"></i> ƒê∆°n h√†ng
                </li>
                <li class="menu-item" onclick="goTo('schedule.html')">
                    <i class="fas fa-calendar-check"></i> ƒê·∫∑t l·ªãch
                </li>
                <li class="menu-item active" onclick="goTo('notifications.html')">
                    <i class="fas fa-bell"></i> Th√¥ng b√°o
                </li>
                <li class="menu-item" onclick="goTo('dailymanagement.html')">
                    <i class="fas fa-store"></i> ƒê·∫°i l√Ω
            </ul>
        </aside>

        <main class="main-content">

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('maintenance')">
                    <i class="fas fa-wrench"></i> Nh·∫Øc b·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥
                    <span class="badge" id="maintenanceBadge">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('parts')">
                    <i class="fas fa-cogs"></i> Nh·∫Øc thay ph·ª• t√πng
                    <span class="badge" id="partsBadge">0</span>
                </button>
            </div>

            <!-- Tab 1: Nh·∫Øc b·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥ (SoLanBaoDuong < 6) -->
            <div id="maintenance-tab" class="tab-content active">

                <div class="table-card">
                    <h2 class="table-title">Danh s√°ch kh√°ch h√†ng c·∫ßn nh·∫Øc b·∫£o d∆∞·ª°ng</h2>
                    <div class="table-container">
                        <table class="notify-table">
                            <thead>
                                <tr>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>ƒêi·ªán tho·∫°i</th>
                                    <th>Lo·∫°i xe</th>
                                    <th>S·ªë l·∫ßn ƒë√£ b·∫£o d∆∞·ª°ng</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody">
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 2: T·∫°o nh·∫Øc nh·ªü thay ph·ª• t√πng -->
            <div id="parts-tab" class="tab-content">
                <div class="info-box warning">
                    <i class="fas fa-bell"></i>
                    <div class="info-box-content">
                        <h3>T·∫°o nh·∫Øc nh·ªü thay th·∫ø ph·ª• t√πng</h3>
                        <p>Ch·ªçn ng∆∞·ªùi d√πng v√† lo·∫°i c√¥ng vi·ªác b·∫£o d∆∞·ª°ng ƒë·ªÉ g·ª≠i nh·∫Øc nh·ªü ƒë·∫øn kh√°ch h√†ng</p>
                    </div>
                </div>

                <!-- Form t·∫°o nh·∫Øc nh·ªü m·ªõi -->
                <div class="table-card" style="margin-bottom: 24px;">
                    <h2 class="table-title"><i class="fas fa-plus-circle"></i> T·∫°o nh·∫Øc nh·ªü m·ªõi</h2>
                    <div class="reminder-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-user"></i> Ch·ªçn ng∆∞·ªùi d√πng</label>
                                <select id="selectUser" class="form-select">
                                    <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-wrench"></i> Lo·∫°i c√¥ng vi·ªác b·∫£o d∆∞·ª°ng</label>
                                <select id="selectJob" class="form-select">
                                    <option value="">-- Ch·ªçn c√¥ng vi·ªác --</option>
                                    <option value="Thay ƒë·∫ßu l·ªçc gi√≥">üîß Thay ƒë·∫ßu l·ªçc gi√≥</option>
                                    <option value="Thay nh·ªõt ƒë·ªông c∆°">üõ¢Ô∏è Thay nh·ªõt ƒë·ªông c∆°</option>
                                    <option value="Thay l·ªçc d·∫ßu">‚öôÔ∏è Thay l·ªçc d·∫ßu</option>
                                    <option value="Thay m√° phanh">üöó Thay m√° phanh</option>
                                    <option value="Thay b·ªô l·ªçc ƒëi·ªÅu h√≤a">‚ùÑÔ∏è Thay b·ªô l·ªçc ƒëi·ªÅu h√≤a</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label><i class="fas fa-comment"></i> Ghi ch√∫ th√™m (tu·ª≥ ch·ªçn)</label>
                                <input type="text" id="noteInput" class="form-input"
                                    placeholder="Nh·∫≠p ghi ch√∫ th√™m n·∫øu c·∫ßn...">
                            </div>
                            <div class="form-group" style="flex: 0 0 auto;">
                                <label>&nbsp;</label>
                                <button class="btn-create-reminder" onclick="createReminder()">
                                    <i class="fas fa-paper-plane"></i> G·ª≠i nh·∫Øc nh·ªü
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danh s√°ch nh·∫Øc nh·ªü ƒë√£ t·∫°o -->
                <div class="table-card">
                    <h2 class="table-title"><i class="fas fa-list"></i> Danh s√°ch nh·∫Øc nh·ªü ƒë√£ g·ª≠i</h2>
                    <div class="table-container">
                        <table class="notify-table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ BD</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>Lo·∫°i xe</th>
                                    <th>N·ªôi dung nh·∫Øc nh·ªü</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="partsTableBody">
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>

        <div class="bottom-brand">
            <div class="brand-name">OTOTECH</div>
            <div class="version">Version: 1.0.0.11</div>
        </div>
    </div>

    <!-- API Service -->
    <script src="asset/api.js"></script>

    <script>
        // Ki·ªÉm tra authentication
        if (!AuthService.isAuthenticated()) {
            window.location.href = 'welcome.html';
        }

        function $(s) { return document.querySelector(s); }

        // Chuy·ªÉn tab
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
        }

        // ==================== TAB 1: NH·∫ÆC B·∫¢O D∆Ø·ª†NG ƒê·ªäNH K·ª≤ ====================
        // (D·ª±a tr√™n NGUOI_DUNG.SoLanBaoDuong)
        async function loadMaintenanceReminders() {
            try {
                Utils.showLoading($('#maintenanceTableBody'));
                const result = await NotificationAPI.getReminders();

                if (result.success) {
                    renderMaintenanceReminders(result.data);
                } else {
                    showEmptyState('maintenanceTableBody', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
                }
            } catch (error) {
                console.error('L·ªói load nh·∫Øc nh·ªü b·∫£o d∆∞·ª°ng:', error);
                showEmptyState('maintenanceTableBody', 'L·ªói k·∫øt n·ªëi server');
            }
        }

        function renderMaintenanceReminders(users) {
            const tbody = $('#maintenanceTableBody');
            tbody.innerHTML = '';

            // L·ªçc nh·ªØng kh√°ch h√†ng c√≥ SoLanBaoDuong < 6 (ƒëang trong chu k·ª≥ b·∫£o d∆∞·ª°ng)
            let needReminder = users.filter(user => {
                const soLan = user.SoLanBaoDuong || 0;
                return soLan < 6;
            });

            // Update badge
            $('#maintenanceBadge').textContent = needReminder.length;

            if (needReminder.length === 0) {
                showEmptyState('maintenanceTableBody', 'Kh√¥ng c√≥ kh√°ch h√†ng n√†o c·∫ßn nh·∫Øc b·∫£o d∆∞·ª°ng');
                return;
            }

            // S·∫Øp x·∫øp: s·ªë l·∫ßn b·∫£o d∆∞·ª°ng th·∫•p tr∆∞·ªõc (c·∫ßn nh·∫Øc g·∫•p)
            needReminder.sort((a, b) => (a.SoLanBaoDuong || 0) - (b.SoLanBaoDuong || 0));

            needReminder.forEach(user => {
                const row = tbody.insertRow();
                const soLan = user.SoLanBaoDuong || 0;
                const lanTiepTheo = soLan + 1;

                let statusHtml = '';
                if (soLan === 0) {
                    statusHtml = '<span class="status-danger">Ch∆∞a b·∫£o d∆∞·ª°ng l·∫ßn n√†o</span>';
                } else if (soLan <= 2) {
                    statusHtml = `<span class="status-warning">L·∫ßn ti·∫øp theo: ${lanTiepTheo}</span>`;
                } else {
                    statusHtml = `<span class="status-info">L·∫ßn ti·∫øp theo: ${lanTiepTheo}</span>`;
                }

                row.innerHTML = `
            <td><strong>${user.TenKhachHang || 'Ch∆∞a c√≥ t√™n'}</strong></td>
            <td>${user.DienThoai || 'N/A'}</td>
            <td>${user.TenLoaiXe || 'Ch∆∞a ƒëƒÉng k√Ω xe'}</td>
            <td>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill ${soLan <= 2 ? 'low' : soLan <= 4 ? 'mid' : 'high'}" 
                             style="width: ${(soLan / 6) * 100}%"></div>
                    </div>
                    <span class="progress-text">${soLan}/6 l·∫ßn</span>
                </div>
            </td>
            <td>${statusHtml}</td>
            <td>
                <button class="btn-send" onclick="sendMaintenanceReminder(${user.MaND}, '${user.TenKhachHang || ''}', ${soLan})">
                    <i class="fas fa-check"></i> Ghi nh·∫≠n b·∫£o d∆∞·ª°ng
                </button>
            </td>
        `;
            });
        }

        // ==================== TAB 2: NH·∫ÆC THAY PH·ª§ T√ôNG ====================
        // (T·ª´ b·∫£ng BAO_DUONG v·ªõi TrangThai = 'Nh·∫Øc nh·ªü' - gi·ªëng Android app)
        async function loadPartsReminders() {
            try {
                Utils.showLoading($('#partsTableBody'));
                const result = await NotificationAPI.getBaoDuongReminders();

                if (result.success) {
                    renderPartsReminders(result.data);
                } else {
                    showEmptyState('partsTableBody', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
                }
            } catch (error) {
                console.error('L·ªói load nh·∫Øc nh·ªü thay ph·ª• t√πng:', error);
                showEmptyState('partsTableBody', 'L·ªói k·∫øt n·ªëi server');
            }
        }

        function renderPartsReminders(reminders) {
            const tbody = $('#partsTableBody');
            tbody.innerHTML = '';

            // Update badge
            $('#partsBadge').textContent = reminders.length;

            if (reminders.length === 0) {
                showEmptyState('partsTableBody', 'Ch∆∞a c√≥ nh·∫Øc nh·ªü n√†o ƒë∆∞·ª£c t·∫°o');
                return;
            }

            reminders.forEach((item, index) => {
                const row = tbody.insertRow();

                row.innerHTML = `
            <td>${index + 1}</td>
            <td><strong>#${item.MaBD}</strong></td>
            <td>
                <strong>${item.TenKhachHang || 'Ch∆∞a c√≥ t√™n'}</strong>
                <br><small class="desc-text">${item.DienThoai || ''}</small>
            </td>
            <td>${item.TenLoaiXe || 'N/A'}<br><small class="desc-text">${item.BienSo || ''}</small></td>
            <td>${item.MoTa || 'Nh·∫Øc nh·ªü thay ph·ª• t√πng'}</td>
            <td><span class="status-warning">${item.TrangThai}</span></td>
            <td>
                <button class="btn-send" onclick="markAsNotified(${item.MaBD}, '${item.TenKhachHang || ''}')">
                    <i class="fas fa-check"></i> ƒê√£ nh·∫Øc
                </button>
            </td>
        `;
            });
        }

        // ==================== LOAD DANH S√ÅCH NG∆Ø·ªúI D√ôNG CHO DROPDOWN ====================
        async function loadUsersForSelect() {
            try {
                const result = await UserAPI.getAll({ limit: 200 });
                if (result.success) {
                    const selectUser = $('#selectUser');
                    selectUser.innerHTML = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>';

                    result.data.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.MaND;
                        option.textContent = `${user.HoTen || user.TenDangNhap} - ${user.DienThoai || 'Ch∆∞a c√≥ SƒêT'}`;
                        selectUser.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('L·ªói load danh s√°ch ng∆∞·ªùi d√πng:', error);
            }
        }

        // ==================== T·∫†O NH·∫ÆC NH·ªû M·ªöI ====================
        async function createReminder() {
            const maND = $('#selectUser').value;
            const job = $('#selectJob').value;
            const note = $('#noteInput').value.trim();

            if (!maND) {
                alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn kh√°ch h√†ng!');
                return;
            }

            if (!job) {
                alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn lo·∫°i c√¥ng vi·ªác b·∫£o d∆∞·ª°ng!');
                return;
            }

            // N·ªôi dung nh·∫Øc nh·ªü = lo·∫°i c√¥ng vi·ªác + ghi ch√∫ (n·∫øu c√≥)
            const moTa = note ? `${job} - ${note}` : job;

            // L·∫•y t√™n kh√°ch h√†ng t·ª´ dropdown
            const selectUser = $('#selectUser');
            const tenKH = selectUser.options[selectUser.selectedIndex].text.split(' - ')[0];

            if (!confirm(`X√°c nh·∫≠n g·ª≠i nh·∫Øc nh·ªü "${job}" cho kh√°ch h√†ng "${tenKH}"?`)) return;

            try {
                const result = await NotificationAPI.createBaoDuongReminder(maND, moTa);
                if (result.success) {
                    alert(`‚úÖ ƒê√£ t·∫°o nh·∫Øc nh·ªü "${job}" cho ${tenKH}!`);
                    // Reset form
                    $('#selectUser').value = '';
                    $('#selectJob').value = '';
                    $('#noteInput').value = '';
                    // Reload danh s√°ch
                    loadPartsReminders();
                } else {
                    alert('‚ùå L·ªói: ' + result.message);
                }
            } catch (error) {
                console.error('L·ªói t·∫°o nh·∫Øc nh·ªü:', error);
                alert('‚ùå L·ªói t·∫°o nh·∫Øc nh·ªü');
            }
        }

        // ==================== G·ª¨I TH√îNG B√ÅO ====================
        async function sendMaintenanceReminder(maND, tenKH, currentCount) {
            const newCount = currentCount + 1;
            const message = newCount === 6
                ? `X√°c nh·∫≠n kh√°ch h√†ng "${tenKH}" ƒë√£ ho√†n th√†nh l·∫ßn b·∫£o d∆∞·ª°ng th·ª© ${newCount} (l·∫ßn cu·ªëi trong chu k·ª≥)?`
                : `X√°c nh·∫≠n kh√°ch h√†ng "${tenKH}" ƒë√£ ho√†n th√†nh l·∫ßn b·∫£o d∆∞·ª°ng th·ª© ${newCount}?`;

            if (!confirm(message)) return;

            try {
                const result = await NotificationAPI.sendReminder(maND);
                if (result.success) {
                    if (newCount >= 6) {
                        alert(`‚úÖ ƒê√£ ghi nh·∫≠n l·∫ßn b·∫£o d∆∞·ª°ng th·ª© ${newCount} cho ${tenKH}!\n\n‚ö†Ô∏è Kh√°ch h√†ng n√†y ƒë√£ ho√†n th√†nh chu k·ª≥ 6 l·∫ßn b·∫£o d∆∞·ª°ng.\nVui l√≤ng t·∫°o nh·∫Øc nh·ªü thay th·∫ø ph·ª• t√πng trong b·∫£ng BAO_DUONG.`);
                    } else {
                        alert(`‚úÖ ƒê√£ ghi nh·∫≠n l·∫ßn b·∫£o d∆∞·ª°ng th·ª© ${newCount} cho ${tenKH}!`);
                    }
                    loadMaintenanceReminders();
                    loadPartsReminders();
                } else {
                    alert('‚ùå L·ªói: ' + result.message);
                }
            } catch (error) {
                console.error('L·ªói g·ª≠i th√¥ng b√°o:', error);
                alert('‚ùå L·ªói g·ª≠i th√¥ng b√°o');
            }
        }

        // ƒê√°nh d·∫•u ƒë√£ nh·∫Øc nh·ªü (c·∫≠p nh·∫≠t TrangThai trong BAO_DUONG)
        async function markAsNotified(maBD, tenKH) {
            if (!confirm(`ƒê√°nh d·∫•u ƒë√£ nh·∫Øc nh·ªü thay ph·ª• t√πng cho kh√°ch h√†ng "${tenKH}"?\n\nTr·∫°ng th√°i s·∫Ω chuy·ªÉn th√†nh "ƒê√£ nh·∫Øc nh·ªü".`)) return;

            try {
                const result = await NotificationAPI.updateBaoDuongStatus(maBD, 'ƒê√£ nh·∫Øc nh·ªü');
                if (result.success) {
                    alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i nh·∫Øc nh·ªü cho ${tenKH}!`);
                    loadPartsReminders();
                } else {
                    alert('‚ùå L·ªói: ' + result.message);
                }
            } catch (error) {
                console.error('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
                alert('‚ùå L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i');
            }
        }

        // ==================== HELPER FUNCTIONS ====================
        function showEmptyState(tableId, message) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = `
        <tr>
            <td colspan="7">
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <h3>Tuy·ªát v·ªùi!</h3>
                    <p>${message}</p>
                </div>
            </td>
        </tr>
    `;
        }

        function goTo(page) {
            window.location.href = page;
        }

        // Load d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', function () {
            loadMaintenanceReminders();
            loadPartsReminders();
            loadUsersForSelect();
        });
    </script>

</body>

</html>