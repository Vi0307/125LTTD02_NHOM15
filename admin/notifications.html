<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTOTECH - Thông báo</title>
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<div class="page-wrapper">

    <!-- Top User -->
    <div class="top-user">
        <span class="username">Administrator</span>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <ul class="menu">
            <li class="menu-item" onclick="goTo('dashboard.html')">
                <i class="fas fa-th-large"></i> Sản phẩm
            </li>
            <li class="menu-item" onclick="goTo('user.html')">
                <i class="fas fa-users"></i> Người dùng
            </li>
            <li class="menu-item" onclick="goTo('order.html')">
                <i class="fas fa-shopping-cart"></i> Đơn hàng
            </li>
            <li class="menu-item" onclick="goTo('schedule.html')">
                <i class="fas fa-calendar-check"></i> Đặt lịch
            </li>
            <li class="menu-item active" onclick="goTo('notifications.html')">
                <i class="fas fa-bell"></i> Thông báo
            </li>
            <li class="menu-item" onclick="goTo('chatbox.html')">
                <i class="fas fa-comments"></i> Chatbox
        </ul>
    </aside>

    <main class="main-content">

        <!-- BẢNG THÔNG BÁO BẢO DƯỠNG SẮP TỚI -->
        <div class="table-card">
            <h2 class="table-title">Danh sách khách hàng cần nhắc bảo dưỡng</h2>
            <div class="table-container">
                <table class="notify-table">
                    <thead>
                        <tr>
                            <th>Khách hàng</th>
                            <th>Tên xe</th>
                            <th>Đã thực hiện</th>
                            <th>Lần tiếp theo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="notifyTableBody">
                        <!-- Dữ liệu sẽ được load từ API -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div class="bottom-brand">
        <div class="brand-name">OTOTECH</div>
        <div class="version">Version: 1.0.0.11</div>
    </div>
</div>

<!-- API Service -->
<script src="asset/api.js"></script>

<script>
// Kiểm tra authentication
if (!AuthService.isAuthenticated()) {
    window.location.href = 'welcome.html';
}

// Load danh sách nhắc bảo dưỡng
async function loadReminders() {
    try {
        Utils.showLoading($('#notifyTableBody'));
        const result = await NotificationAPI.getReminders();
        
        if (result.success) {
            renderReminders(result.data);
        } else {
            alert('Lỗi: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi load nhắc nhở:', error);
        alert('Lỗi tải dữ liệu nhắc nhở');
    }
}

// Render danh sách nhắc bảo dưỡng
function renderReminders(reminders) {
    const tbody = $('#notifyTableBody');
    tbody.innerHTML = '';
    
    if (reminders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">Không có khách hàng nào cần nhắc bảo dưỡng</td></tr>';
        return;
    }
    
    reminders.forEach(reminder => {
        const row = tbody.insertRow();
        const soLan = reminder.SoLanBaoDuong || 0;
        const lanTiepTheo = soLan + 1;
        row.innerHTML = `
            <td>${reminder.TenKhachHang || 'Chưa có tên'}</td>
            <td>${reminder.TenLoaiXe || 'Chưa đăng ký xe'}</td>
            <td>${soLan} lần</td>
            <td>Lần thứ ${lanTiepTheo}</td>
            <td class="action-icons">
                <i class="fas fa-bell bell-notify" style="color:#ffc107;cursor:pointer;margin-right:10px;" title="Gửi thông báo nhắc nhở" onclick="sendReminder(${reminder.MaND}, '${reminder.TenKhachHang || ''}')"></i>
                <i class="fas fa-check-circle" style="color:#28a745;cursor:pointer;" title="Đánh dấu hoàn tất (6 lần)" onclick="deleteReminder(${reminder.MaND}, '${reminder.TenKhachHang || ''}')"></i>
            </td>
        `;
    });
}

// Gửi thông báo nhắc nhở
async function sendReminder(maND, tenKH) {
    event.stopPropagation();
    
    if (!confirm(`Gửi thông báo nhắc bảo dưỡng cho khách hàng "${tenKH}"?`)) return;

    try {
        const result = await NotificationAPI.sendReminder(maND);
        if (result.success) {
            alert(`Đã gửi thành công thông báo đến ${tenKH}!`);
            loadReminders();
        } else {
            alert('Lỗi: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi gửi thông báo:', error);
        alert('Lỗi gửi thông báo');
    }
}

// Xóa khỏi danh sách nhắc nhở
async function deleteReminder(maND, tenKH) {
    event.stopPropagation();
    
    if (!confirm(`Xóa khách hàng "${tenKH}" khỏi danh sách nhắc bảo dưỡng?`)) return;

    try {
        const result = await NotificationAPI.deleteReminder(maND);
        if (result.success) {
            alert(`Đã xóa ${tenKH} khỏi danh sách!`);
            loadReminders();
        } else {
            alert('Lỗi: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi xóa:', error);
        alert('Lỗi xóa nhắc nhở');
    }
}

function $(s) { return document.querySelector(s); }

function goTo(page) {
    window.location.href = page;
}

// Load dữ liệu khi trang được tải
document.addEventListener('DOMContentLoaded', function() {
    loadReminders();
});
</script>

</body>
</html>