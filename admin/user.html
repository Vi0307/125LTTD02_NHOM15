<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTOTECH - Khách hàng</title>
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="dashboard-body admin-body">

<div class="page-wrapper">

    <!-- Top User & Sidebar giữ nguyên -->
    <div class="top-user">
        <span class="username">Administrator</span>
    </div>

    <aside class="sidebar">
        <ul class="menu">
            <li class="menu-item " onclick="goTo('dashboard.html')">
                <i class="fas fa-th-large"></i> Sản phẩm
            </li>
            <li class="menu-item active" onclick="goTo('user.html')">
                <i class="fas fa-users"></i> Người dùng
            </li>
            <li class="menu-item" onclick="goTo('order.html')">
                <i class="fas fa-shopping-cart"></i> Đơn hàng
            </li>
            <li class="menu-item" onclick="goTo('schedule.html')">
                <i class="fas fa-calendar-check"></i> Đặt lịch
            </li>
            <li class="menu-item" onclick="goTo('notifications.html')">
                <i class="fas fa-bell"></i> Thông báo
            </li>
            <li class="menu-item" onclick="goTo('chatbox.html')">
                <i class="fas fa-comments"></i> Chatbox
        </ul>
    </aside>

    <main class="admin-main">
        <section class="panel-grid">

            <!-- BẢNG KHÁCH HÀNG -->
            <div class="table-card">
                <h2 class="table-title">Khách hàng</h2>
                <div class="table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Mã KH</th>
                                <th>Tên khách hàng</th>
                                <th>SĐT</th>
                                <th>Email</th>
                                <th>Số lần bảo dưỡng</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- Dữ liệu sẽ được load từ API -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- FORM CHI TIẾT -->
            <div id="userDetailCard" class="detail-card">
                <h2 class="detail-title">Chi tiết khách hàng</h2>
                <div class="form-grid-user">

                    <div class="form-group"><label>Mã khách hàng</label><input type="text" id="maKH" readonly></div>
                    <div class="form-group"><label>Loại xe</label><input type="text" id="loaiXe" readonly></div>
                    <div class="form-group"><label>SĐT</label><input type="text" id="sdt"></div>

                    <div class="form-group"><label>Mã xe</label><input type="text" id="maXe" readonly></div>

                    <!-- MẬT KHẨU LUÔN HIỆN ******** -->
                    <div class="form-group">
                        <label>Mật khẩu</label>
                        <input type="text" id="matKhau" value="********" readonly style="color:#666; font-weight:600; letter-spacing:2px;">
                    </div>

                    <!-- SỐ LẦN BẢO DƯỠNG: CHỈ TỪ 0 ĐẾN 6 -->
                    <div class="form-group">
                        <label>Số lần bảo dưỡng</label>
                        <select id="soLanBaoDuong">
                            <option value="0">0 lần</option>
                            <option value="1">1 lần</option>
                            <option value="2">2 lần</option>
                            <option value="3">3 lần</option>
                            <option value="4">4 lần</option>
                            <option value="5">5 lần</option>
                            <option value="6" selected>6 lần</option>
                        </select>
                    </div>

                    <div class="form-group"><label>Tên khách hàng</label><input type="text" id="tenKH"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="email"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn-update" onclick="updateUser()">
                        Cập nhật
                    </button>
                </div>
            </div>

        </section>
    </main>

    <div class="bottom-brand">
        <div class="brand-name">OTOTECH</div>
        <div class="version">Version: 1.0.0.11</div>
    </div>
</div>

<!-- API Service -->
<script src="asset/api.js"></script>

<script>
// Kiểm tra authentication
if (!AuthService.isAuthenticated()) {
    window.location.href = 'welcome.html';
}

var currentUserRow = null;
var currentUserId = null;

function $(s) { return document.querySelector(s); }

// Load danh sách người dùng
async function loadUsers() {
    try {
        Utils.showLoading($('#userTableBody'));
        const result = await UserAPI.getAll({ limit: 100 });
        
        if (result.success) {
            renderUsers(result.data);
        } else {
            alert('Lỗi: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi load người dùng:', error);
        alert('Lỗi tải dữ liệu người dùng');
    }
}

// Render danh sách người dùng
function renderUsers(users) {
    const tbody = $('#userTableBody');
    tbody.innerHTML = '';
    
    users.forEach(user => {
        const row = tbody.insertRow();
        row.onclick = () => fillUserForm(row, user);
        row.innerHTML = `
            <td>${user.MaND}</td>
            <td>${user.HoTen}</td>
            <td>${user.DienThoai || ''}</td>
            <td>${user.Email || ''}</td>
            <td>${user.SoLanBaoDuong || 0}</td>
            <td>
                <i class="fas fa-lock lock-icon ${user.IsLocked ? 'locked' : ''}" 
                   title="${user.IsLocked ? 'Đã khóa' : 'Đang mở'}"
                   onclick="event.stopPropagation(); lockUser(${user.MaND}, ${user.IsLocked})"></i>
            </td>
            <td class="action-icons">
                <i class="fas fa-trash delete-icon" onclick="event.stopPropagation(); deleteUser(${user.MaND})"></i>
            </td>
        `;
    });
}

async function fillUserForm(row, user) {
    currentUserRow = row;
    currentUserId = user.MaND;

    const card = document.getElementById('userDetailCard');
    card.style.display = 'block';

    $('#maKH').value = user.MaND;
    $('#tenKH').value = user.HoTen;
    $('#sdt').value = user.DienThoai || '';
    $('#email').value = user.Email || '';
    $('#soLanBaoDuong').value = user.SoLanBaoDuong || 0;
    $('#loaiXe').value = user.TenLoaiXe || '';
    $('#maXe').value = user.MaXe || '';

    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

async function lockUser(maND, isLocked) {
    event.stopPropagation();
    const action = isLocked ? 'Mở khóa' : 'Khóa';
    
    if (!confirm(`${action} tài khoản ${maND}?`)) return;

    try {
        const result = await UserAPI.toggleLock(maND, !isLocked);
        if (result.success) {
            alert(result.message);
            loadUsers();
        } else {
            alert('Lỗi: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi khóa/mở khóa:', error);
        alert('Lỗi thực hiện thao tác');
    }
}

async function deleteUser(maND) {
    if (!confirm('Xóa khách hàng này vĩnh viễn?')) return;

    try {
        const result = await UserAPI.delete(maND);
        if (result.success) {
            alert('Xóa thành công!');
            loadUsers();
            document.getElementById('userDetailCard').style.display = 'none';
        } else {
            alert('Lỗi: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi xóa:', error);
        alert('Lỗi xóa người dùng');
    }
}

async function updateUser() {
    if (!currentUserId) return alert('Vui lòng chọn khách hàng!');

    const userData = {
        HoTen: $('#tenKH').value.trim(),
        DienThoai: $('#sdt').value.trim(),
        Email: $('#email').value.trim(),
        SoLanBaoDuong: parseInt($('#soLanBaoDuong').value) || 0
    };

    try {
        const result = await UserAPI.update(currentUserId, userData);
        if (result.success) {
            alert('Cập nhật thành công!');
            loadUsers();
        } else {
            alert('Lỗi: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi cập nhật:', error);
        alert('Lỗi cập nhật người dùng');
    }
}

function goTo(page) {
    window.location.href = page;
}

// Load dữ liệu khi trang được tải
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});
</script>

</body>
</html>