<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTOTECH - Quản lý sản phẩm</title>
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="dashboard-body admin-body">

    <div class="page-wrapper">

        <!-- Top User (cố định) -->
        <div class="top-user">
            <span class="username">Administrator</span>
        </div>

        <!-- Sidebar (cố định) -->
        <aside class="sidebar">
            <ul class="menu">
                <li class="menu-item active" onclick="goTo('dashboard.html')">
                    <i class="fas fa-th-large"></i> Sản phẩm
                </li>
                <li class="menu-item" onclick="goTo('user.html')">
                    <i class="fas fa-users"></i> Người dùng
                </li>
                <li class="menu-item" onclick="goTo('order.html')">
                    <i class="fas fa-shopping-cart"></i> Đơn hàng
                </li>
                <li class="menu-item" onclick="goTo('schedule.html')">
                    <i class="fas fa-calendar-check"></i> Đặt lịch
                </li>
                <li class="menu-item" onclick="goTo('notifications.html')">
                    <i class="fas fa-bell"></i> Thông báo
                </li>
                <li class="menu-item" onclick="goTo('dailymanagement.html')">
                    <i class="fas fa-store"></i> Đại lý
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">

            <section class="panel-grid">
                <!-- BẢNG SẢN PHẨM -->
                <div class="table-card">
                    <h2 class="table-title" id="categoryTitle">Sản phẩm</h2>
                    <div class="table-container">
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>Mã phụ tùng</th>
                                    <th>Tên phụ tùng</th>
                                    <th>Loại xe</th>
                                    <th>Giá</th>
                                    <th>Mã danh mục</th>
                                    <th>Hình ảnh</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                <!-- Dữ liệu sẽ được load từ API -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- PHẦN CHI TIẾT -->
                <div class="detail-card show-on-load">
                    <div class="detail-header">
                        <h2>Chi tiết <i class="fas fa-edit"></i></h2>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mã phụ tùng</label>
                            <input type="text" id="maPhuTung" placeholder="VD: X001">
                        </div>
                        <div class="form-group">
                            <label>Giá</label>
                            <input type="text" id="gia" placeholder="VD: 7.000.000VND">
                        </div>
                        <div class="form-group">
                            <label>Image</label>
                            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-cloud-upload-alt"></i> Upload Image
                            </button>
                            <input type="file" id="fileInput" accept="image/*" style="display:none"
                                onchange="previewImage(event)">
                        </div>

                        <div class="form-group">
                            <label>Tên phụ tùng</label>
                            <input type="text" id="tenPhuTung" placeholder="VD: Ống gió nạp hơi">
                        </div>
                        <div class="form-group">
                            <label>Mã danh mục</label>
                            <input type="text" id="maDanhMuc" value="1" placeholder="VD: 1">
                        </div>
                        <div class="form-group image-preview">
                            <img id="imgPreview" src="" alt="Preview"
                                style="display:none; width:200px; height:140px; object-fit:cover; border:2px dashed #ccc; border-radius:12px;">
                        </div>

                        <div class="form-group full-width">
                            <label>Loại xe</label>
                            <select id="loaiXe">
                                <option>BMW i5</option>
                                <option>BMW i3</option>
                                <option>BMW X5</option>
                                <option>BMW Z4</option>
                            </select>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-add"><i class="fas fa-plus"></i> Thêm</button>
                        <button class="btn-update"><i class="fas fa-edit"></i> Cập nhật</button>
                        <button class="btn-refresh" onclick="resetForm()"><i class="fas fa-sync-alt"></i>
                            Refresh</button>
                    </div>
                </div>
            </section>

        </main>

        <!-- Bottom Brand (cố định) -->
        <div class="bottom-brand">
            <div class="brand-name">OTOTECH</div>
            <div class="version">Version: 1.0.0.11</div>
        </div>
    </div>

    <!-- API Service -->
    <script src="asset/api.js"></script>

    <script>
        // Kiểm tra authentication
        if (!AuthService.isAuthenticated()) {
            window.location.href = 'welcome.html';
        }

        let currentRow = null;
        let currentProductId = null;
        let currentCategoryId = null;
        let currentProduct = null; // Lưu thông tin sản phẩm đang chọn

        // Dữ liệu loại xe và danh mục
        let vehicleTypes = [];
        let categories = [];

        // Helper
        function $(s) { return document.querySelector(s); }

        // Lấy category ID từ URL
        function getCategoryIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('category') || urlParams.get('maDanhMuc') || null;
        }

        // Load danh sách loại xe từ API
        async function loadVehicleTypes() {
            try {
                const result = await apiCall('/vehicle-types');
                if (result.success && result.data && result.data.length > 0) {
                    vehicleTypes = result.data;
                    renderVehicleTypeOptions();
                } else {
                    // Fallback khi API không thành công
                    console.log('API vehicle-types không thành công, dùng dữ liệu mặc định');
                    vehicleTypes = [
                        { MaLoaiXe: 'LX1', TenLoaiXe: 'BMW 5 SERIES' },
                        { MaLoaiXe: 'LX2', TenLoaiXe: 'BMW Z4' },
                        { MaLoaiXe: 'LX3', TenLoaiXe: 'BMW I5' },
                        { MaLoaiXe: 'LX4', TenLoaiXe: 'BMW 3 SERIES' }
                    ];
                    renderVehicleTypeOptions();
                }
            } catch (error) {
                console.error('Lỗi load loại xe:', error);
                // Fallback với dữ liệu mặc định từ database
                vehicleTypes = [
                    { MaLoaiXe: 'LX1', TenLoaiXe: 'BMW 5 SERIES' },
                    { MaLoaiXe: 'LX2', TenLoaiXe: 'BMW Z4' },
                    { MaLoaiXe: 'LX3', TenLoaiXe: 'BMW I5' },
                    { MaLoaiXe: 'LX4', TenLoaiXe: 'BMW 3 SERIES' }
                ];
                renderVehicleTypeOptions();
            }
        }

        // Render options cho dropdown loại xe
        function renderVehicleTypeOptions() {
            const select = $('#loaiXe');
            select.innerHTML = '';
            vehicleTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.MaLoaiXe;
                option.textContent = type.TenLoaiXe;
                select.appendChild(option);
            });
        }

        // Load danh sách danh mục từ API
        async function loadCategories() {
            const categoryId = getCategoryIdFromURL();

            try {
                const result = await CategoryAPI.getAll();
                if (result.success && result.data) {
                    categories = result.data;
                    renderCategoryOptions(categoryId);
                }
            } catch (error) {
                console.error('Lỗi load danh mục:', error);
                // Fallback với dữ liệu mặc định từ database
                categories = [
                    { MaDanhMuc: 'DM01', TenDanhMuc: 'Phụ tùng thân vỏ' },
                    { MaDanhMuc: 'DM02', TenDanhMuc: 'Phụ tùng truyền động' },
                    { MaDanhMuc: 'DM03', TenDanhMuc: 'Phụ tùng điện' },
                    { MaDanhMuc: 'DM04', TenDanhMuc: 'Phụ tùng động cơ' }
                ];
                renderCategoryOptions(categoryId);
            }
        }

        // Render options cho dropdown danh mục - chỉ hiển thị danh mục hiện tại
        function renderCategoryOptions(categoryIdFromURL) {
            const input = $('#maDanhMuc');
            // Chuyển input thành select
            const select = document.createElement('select');
            select.id = 'maDanhMuc';

            // Nếu có categoryId từ URL, chỉ hiển thị danh mục đó và disable
            if (categoryIdFromURL) {
                const currentCat = categories.find(cat => cat.MaDanhMuc === categoryIdFromURL);
                if (currentCat) {
                    const option = document.createElement('option');
                    option.value = currentCat.MaDanhMuc;
                    option.textContent = currentCat.TenDanhMuc;
                    select.appendChild(option);
                }
                select.disabled = true; // Không cho thay đổi danh mục
                select.style.backgroundColor = '#f0f0f0';
                select.style.cursor = 'not-allowed';
            } else {
                // Nếu không có categoryId, hiển thị tất cả (cho trường hợp xem tất cả sản phẩm)
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.MaDanhMuc;
                    option.textContent = cat.TenDanhMuc;
                    select.appendChild(option);
                });
            }

            input.parentNode.replaceChild(select, input);
        }

        // Load thông tin danh mục
        async function loadCategoryInfo() {
            const categoryId = getCategoryIdFromURL();
            if (!categoryId) {
                $('#categoryTitle').textContent = 'Tất cả sản phẩm';
                return;
            }

            try {
                const result = await CategoryAPI.getById(categoryId);
                if (result.success && result.data) {
                    $('#categoryTitle').textContent = result.data.TenDanhMuc || 'Sản phẩm';
                    currentCategoryId = categoryId;
                }
            } catch (error) {
                console.error('Lỗi load danh mục:', error);
            }
        }

        // Load danh sách sản phẩm từ API
        async function loadProducts() {
            try {
                Utils.showLoading($('#productTableBody'));
                const categoryId = getCategoryIdFromURL();

                const params = { limit: 50 }; // Hiển thị đến 50 sản phẩm
                if (categoryId) {
                    params.maDanhMuc = categoryId;
                }

                const result = await ProductAPI.getAll(params);

                if (result.success) {
                    renderProducts(result.data);
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi load sản phẩm:', error);
                alert('Lỗi tải dữ liệu sản phẩm');
            }
        }

        // Render danh sách sản phẩm
        function renderProducts(products) {
            const tbody = $('#productTableBody');
            tbody.innerHTML = '';

            products.forEach(product => {
                const row = tbody.insertRow();
                row.onclick = () => fillForm(row, product);
                row.innerHTML = `
            <td>${product.MaPhuTung}</td>
            <td>${product.TenPhuTung}</td>
            <td>${product.TenLoaiXe || product.MaLoaiXe}</td>
            <td>${Utils.formatCurrency(product.GiaBan)}</td>
            <td>${product.MaDanhMuc}</td>
            <td><img src="asset/${product.HinhAnh}" style="width:70px; height:50px; object-fit:cover;" onerror="this.src='asset/car-icon.png'"></td>
            <td class="actions">
                <i class="fas fa-edit edit-icon"></i>
                <i class="fas fa-trash trash-icon" onclick="event.stopPropagation(); deleteRow('${product.MaPhuTung}')"></i>
            </td>
        `;
            });
        }

        // Điền dữ liệu lên form
        function fillForm(row, product) {
            currentRow = row;
            currentProductId = product.MaPhuTung;
            currentProduct = product; // Lưu toàn bộ thông tin sản phẩm

            $('#maPhuTung').value = product.MaPhuTung;
            $('#tenPhuTung').value = product.TenPhuTung;
            // Sử dụng MaLoaiXe thay vì TenLoaiXe
            $('#loaiXe').value = product.MaLoaiXe;
            $('#gia').value = product.GiaBan;
            // Sử dụng MaDanhMuc đúng format
            $('#maDanhMuc').value = product.MaDanhMuc;

            const preview = $('#imgPreview');
            if (product.HinhAnh) {
                preview.src = `asset/${product.HinhAnh}`;
                preview.style.display = 'block';
            }
        }

        // Xóa sản phẩm
        async function deleteRow(maPhuTung) {
            if (!confirm('Xóa sản phẩm này?')) return;

            try {
                const result = await ProductAPI.delete(maPhuTung);
                if (result.success) {
                    alert('Xóa thành công!');
                    loadProducts();
                    resetForm();
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi xóa:', error);
                alert('Lỗi xóa sản phẩm');
            }
        }

        // Reset form
        function resetForm() {
            $('#maPhuTung').value = '';
            $('#tenPhuTung').value = '';
            $('#loaiXe').selectedIndex = 0;
            $('#gia').value = '';
            const maDanhMucSelect = $('#maDanhMuc');
            if (maDanhMucSelect) {
                maDanhMucSelect.selectedIndex = 0;
            }
            const preview = $('#imgPreview');
            preview.src = '';
            preview.style.display = 'none';
            currentRow = null;
            currentProductId = null;
            currentProduct = null;
        }

        // Preview ảnh khi chọn file
        function previewImage(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = $('#imgPreview');
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            }
        }

        // Lấy tên file hình ảnh
        function getImageFileName() {
            const preview = $('#imgPreview');
            if (preview.src.includes('blob:')) {
                // Nếu là file mới upload, dùng tên mặc định hoặc tên file
                const fileInput = $('#fileInput');
                if (fileInput.files.length > 0) {
                    return fileInput.files[0].name;
                }
                return 'default.png';
            }
            // Lấy tên file từ URL
            const parts = preview.src.split('/');
            return parts[parts.length - 1] || 'default.png';
        }

        // Nút Thêm
        $('.btn-add').onclick = async function () {
            const maPhuTung = $('#maPhuTung').value.trim();
            const tenPhuTung = $('#tenPhuTung').value.trim();
            const gia = $('#gia').value.trim();
            const maLoaiXe = $('#loaiXe').value;
            // Ưu tiên lấy maDanhMuc từ URL (vì dropdown có thể bị disabled)
            const maDanhMuc = getCategoryIdFromURL() || $('#maDanhMuc').value;

            if (!maPhuTung || !tenPhuTung || !gia) {
                alert('Vui lòng nhập đầy đủ thông tin bắt buộc!');
                return;
            }

            if (!maLoaiXe || !maDanhMuc) {
                alert('Vui lòng chọn loại xe và danh mục!');
                return;
            }

            try {
                const productData = {
                    MaPhuTung: maPhuTung,
                    MaHangXe: 'BMW', // Mặc định
                    MaLoaiXe: maLoaiXe, // Sử dụng MaLoaiXe từ dropdown (VD: LX1, LX2...)
                    TenPhuTung: tenPhuTung,
                    GiaBan: parseFloat(gia.toString().replace(/[^\d]/g, '')),
                    SoLuong: 1,
                    MoTa: '',
                    HinhAnh: getImageFileName(),
                    MaDanhMuc: maDanhMuc, // Sử dụng MaDanhMuc từ URL hoặc dropdown (VD: DM01, DM02...)
                    NhaCC: 'Royal Auto'
                };

                console.log('Dữ liệu gửi lên:', productData); // Debug

                const result = await ProductAPI.create(productData);
                if (result.success) {
                    alert('Thêm sản phẩm thành công!');
                    loadProducts();
                    resetForm();
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi thêm:', error);
                alert('Lỗi thêm sản phẩm');
            }
        };

        // Nút Cập nhật
        $('.btn-update').onclick = async function () {
            if (!currentProductId) {
                alert('Vui lòng chọn một sản phẩm để cập nhật!');
                return;
            }

            const tenPhuTung = $('#tenPhuTung').value.trim();
            const gia = $('#gia').value.trim();

            if (!tenPhuTung || !gia) {
                alert('Vui lòng nhập đầy đủ thông tin!');
                return;
            }

            try {
                // Lấy số lượng từ sản phẩm hiện tại hoặc mặc định là 1
                const soLuong = currentProduct ? (currentProduct.SoLuong || 1) : 1;

                const productData = {
                    TenPhuTung: tenPhuTung,
                    GiaBan: parseFloat(gia.toString().replace(/[^\d]/g, '')),
                    SoLuong: soLuong,
                    MoTa: currentProduct ? (currentProduct.MoTa || '') : '',
                    HinhAnh: getImageFileName(),
                    NhaCC: currentProduct ? (currentProduct.NhaCC || 'Royal Auto') : 'Royal Auto'
                };

                console.log('Dữ liệu cập nhật:', productData); // Debug

                const result = await ProductAPI.update(currentProductId, productData);
                if (result.success) {
                    alert('Cập nhật thành công!');
                    loadProducts();
                    resetForm();
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi cập nhật:', error);
                alert('Lỗi cập nhật sản phẩm');
            }
        };

        function goTo(page) {
            window.location.href = page;
        }

        // Load dữ liệu khi trang được tải
        document.addEventListener('DOMContentLoaded', async function () {
            // Load dropdown data trước
            await loadVehicleTypes();
            await loadCategories();
            // Sau đó load thông tin và sản phẩm
            loadCategoryInfo();
            loadProducts();
        });
    </script>

</body>

</html>