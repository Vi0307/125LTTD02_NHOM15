<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTOTECH - Qu·∫£n l√Ω s·∫£n ph·∫©m</title>
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="dashboard-body admin-body">

    <div class="page-wrapper">

        <!-- Top User (c·ªë ƒë·ªãnh) -->
        <div class="top-user">
            <span class="username">Administrator</span>
        </div>

        <!-- Sidebar (c·ªë ƒë·ªãnh) -->
        <aside class="sidebar">
            <ul class="menu">
                <li class="menu-item active" onclick="goTo('dashboard.html')">
                    <i class="fas fa-th-large"></i> S·∫£n ph·∫©m
                </li>
                <li class="menu-item" onclick="goTo('user.html')">
                    <i class="fas fa-users"></i> Ng∆∞·ªùi d√πng
                </li>
                <li class="menu-item" onclick="goTo('order.html')">
                    <i class="fas fa-shopping-cart"></i> ƒê∆°n h√†ng
                </li>
                <li class="menu-item" onclick="goTo('schedule.html')">
                    <i class="fas fa-calendar-check"></i> ƒê·∫∑t l·ªãch
                </li>
                <li class="menu-item" onclick="goTo('notifications.html')">
                    <i class="fas fa-bell"></i> Th√¥ng b√°o
                </li>
                <li class="menu-item" onclick="goTo('dailymanagement.html')">
                    <i class="fas fa-store"></i> ƒê·∫°i l√Ω
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">

            <section class="panel-grid">
                <!-- B·∫¢NG S·∫¢N PH·∫®M -->
                <div class="table-card">
                    <h2 class="table-title" id="categoryTitle">S·∫£n ph·∫©m</h2>
                    <div class="table-container">
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>M√£ ph·ª• t√πng</th>
                                    <th>T√™n ph·ª• t√πng</th>
                                    <th>Lo·∫°i xe</th>
                                    <th>Gi√°</th>
                                    <th>M√£ danh m·ª•c</th>
                                    <th>H√¨nh ·∫£nh</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- PH·∫¶N CHI TI·∫æT -->
                <div class="detail-card show-on-load">
                    <div class="detail-header">
                        <h2>Chi ti·∫øt <i class="fas fa-edit"></i></h2>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>M√£ ph·ª• t√πng</label>
                            <input type="text" id="maPhuTung" placeholder="VD: X001">
                        </div>
                        <div class="form-group">
                            <label>Gi√°</label>
                            <input type="text" id="gia" placeholder="VD: 7.000.000VND">
                        </div>
                        <div class="form-group">
                            <label>Image</label>
                            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-cloud-upload-alt"></i> Upload Image
                            </button>
                            <input type="file" id="fileInput" accept="image/*" style="display:none"
                                onchange="previewImage(event)">
                        </div>

                        <div class="form-group">
                            <label>T√™n ph·ª• t√πng</label>
                            <input type="text" id="tenPhuTung" placeholder="VD: ·ªêng gi√≥ n·∫°p h∆°i">
                        </div>
                        <div class="form-group">
                            <label>M√£ danh m·ª•c</label>
                            <input type="text" id="maDanhMuc" value="1" placeholder="VD: 1">
                        </div>
                        <div class="form-group image-preview">
                            <img id="imgPreview" src="" alt="Preview"
                                style="display:none; width:200px; height:140px; object-fit:cover; border:2px dashed #ccc; border-radius:12px;">
                        </div>

                        <div class="form-group full-width">
                            <label>Lo·∫°i xe</label>
                            <select id="loaiXe">
                                <option>BMW i5</option>
                                <option>BMW i3</option>
                                <option>BMW X5</option>
                                <option>BMW Z4</option>
                            </select>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-add"><i class="fas fa-plus"></i> Th√™m</button>
                        <button class="btn-update"><i class="fas fa-edit"></i> C·∫≠p nh·∫≠t</button>
                        <button class="btn-refresh" onclick="resetForm()"><i class="fas fa-sync-alt"></i>
                            Refresh</button>
                    </div>
                </div>
            </section>

        </main>

        <!-- Bottom Brand (c·ªë ƒë·ªãnh) -->
        <div class="bottom-brand">
            <div class="brand-name">OTOTECH</div>
            <div class="version">Version: 1.0.0.11</div>
        </div>
    </div>

    <!-- API Service -->
    <script src="asset/api.js"></script>

    <script>
        // Ki·ªÉm tra authentication
        if (!AuthService.isAuthenticated()) {
            window.location.href = 'welcome.html';
        }

        let currentRow = null;
        let currentProductId = null;
        let currentCategoryId = null;
        let currentProduct = null; // L∆∞u th√¥ng tin s·∫£n ph·∫©m ƒëang ch·ªçn

        // D·ªØ li·ªáu lo·∫°i xe v√† danh m·ª•c
        let vehicleTypes = [];
        let categories = [];

        // Helper
        function $(s) { return document.querySelector(s); }

        // L·∫•y category ID t·ª´ URL
        function getCategoryIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('category') || urlParams.get('maDanhMuc') || null;
        }

        // Load danh s√°ch lo·∫°i xe t·ª´ API
        async function loadVehicleTypes() {
            try {
                const result = await apiCall('/vehicle-types');
                if (result.success && result.data && result.data.length > 0) {
                    vehicleTypes = result.data;
                    renderVehicleTypeOptions();
                } else {
                    // Fallback khi API kh√¥ng th√†nh c√¥ng
                    console.log('API vehicle-types kh√¥ng th√†nh c√¥ng, d√πng d·ªØ li·ªáu m·∫∑c ƒë·ªãnh');
                    vehicleTypes = [
                        { MaLoaiXe: 'LX1', TenLoaiXe: 'BMW 5 SERIES' },
                        { MaLoaiXe: 'LX2', TenLoaiXe: 'BMW Z4' },
                        { MaLoaiXe: 'LX3', TenLoaiXe: 'BMW I5' },
                        { MaLoaiXe: 'LX4', TenLoaiXe: 'BMW 3 SERIES' }
                    ];
                    renderVehicleTypeOptions();
                }
            } catch (error) {
                console.error('L·ªói load lo·∫°i xe:', error);
                // Fallback v·ªõi d·ªØ li·ªáu m·∫∑c ƒë·ªãnh t·ª´ database
                vehicleTypes = [
                    { MaLoaiXe: 'LX1', TenLoaiXe: 'BMW 5 SERIES' },
                    { MaLoaiXe: 'LX2', TenLoaiXe: 'BMW Z4' },
                    { MaLoaiXe: 'LX3', TenLoaiXe: 'BMW I5' },
                    { MaLoaiXe: 'LX4', TenLoaiXe: 'BMW 3 SERIES' }
                ];
                renderVehicleTypeOptions();
            }
        }

        // Render options cho dropdown lo·∫°i xe
        function renderVehicleTypeOptions() {
            const select = $('#loaiXe');
            select.innerHTML = '';
            vehicleTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.MaLoaiXe;
                option.textContent = type.TenLoaiXe;
                select.appendChild(option);
            });
        }

        // Load danh s√°ch danh m·ª•c t·ª´ API
        async function loadCategories() {
            const categoryId = getCategoryIdFromURL();

            try {
                const result = await CategoryAPI.getAll();
                if (result.success && result.data) {
                    categories = result.data;
                    renderCategoryOptions(categoryId);
                }
            } catch (error) {
                console.error('L·ªói load danh m·ª•c:', error);
                // Fallback v·ªõi d·ªØ li·ªáu m·∫∑c ƒë·ªãnh t·ª´ database
                categories = [
                    { MaDanhMuc: 'DM01', TenDanhMuc: 'Ph·ª• t√πng th√¢n v·ªè' },
                    { MaDanhMuc: 'DM02', TenDanhMuc: 'Ph·ª• t√πng truy·ªÅn ƒë·ªông' },
                    { MaDanhMuc: 'DM03', TenDanhMuc: 'Ph·ª• t√πng ƒëi·ªán' },
                    { MaDanhMuc: 'DM04', TenDanhMuc: 'Ph·ª• t√πng ƒë·ªông c∆°' }
                ];
                renderCategoryOptions(categoryId);
            }
        }

        // Render options cho dropdown danh m·ª•c - ch·ªâ hi·ªÉn th·ªã danh m·ª•c hi·ªán t·∫°i
        function renderCategoryOptions(categoryIdFromURL) {
            const input = $('#maDanhMuc');
            // Chuy·ªÉn input th√†nh select
            const select = document.createElement('select');
            select.id = 'maDanhMuc';

            // N·∫øu c√≥ categoryId t·ª´ URL, ch·ªâ hi·ªÉn th·ªã danh m·ª•c ƒë√≥ v√† disable
            if (categoryIdFromURL) {
                const currentCat = categories.find(cat => cat.MaDanhMuc === categoryIdFromURL);
                if (currentCat) {
                    const option = document.createElement('option');
                    option.value = currentCat.MaDanhMuc;
                    option.textContent = currentCat.TenDanhMuc;
                    select.appendChild(option);
                }
                select.disabled = true; // Kh√¥ng cho thay ƒë·ªïi danh m·ª•c
                select.style.backgroundColor = '#f0f0f0';
                select.style.cursor = 'not-allowed';
            } else {
                // N·∫øu kh√¥ng c√≥ categoryId, hi·ªÉn th·ªã t·∫•t c·∫£ (cho tr∆∞·ªùng h·ª£p xem t·∫•t c·∫£ s·∫£n ph·∫©m)
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.MaDanhMuc;
                    option.textContent = cat.TenDanhMuc;
                    select.appendChild(option);
                });
            }

            input.parentNode.replaceChild(select, input);
        }

        // Load th√¥ng tin danh m·ª•c
        async function loadCategoryInfo() {
            const categoryId = getCategoryIdFromURL();
            if (!categoryId) {
                $('#categoryTitle').textContent = 'T·∫•t c·∫£ s·∫£n ph·∫©m';
                return;
            }

            try {
                const result = await CategoryAPI.getById(categoryId);
                if (result.success && result.data) {
                    $('#categoryTitle').textContent = result.data.TenDanhMuc || 'S·∫£n ph·∫©m';
                    currentCategoryId = categoryId;
                }
            } catch (error) {
                console.error('L·ªói load danh m·ª•c:', error);
            }
        }

        // Load danh s√°ch s·∫£n ph·∫©m t·ª´ API
        async function loadProducts() {
            try {
                Utils.showLoading($('#productTableBody'));
                const categoryId = getCategoryIdFromURL();

                const params = { limit: 50 }; // Hi·ªÉn th·ªã ƒë·∫øn 50 s·∫£n ph·∫©m
                if (categoryId) {
                    params.maDanhMuc = categoryId;
                }

                const result = await ProductAPI.getAll(params);

                if (result.success) {
                    renderProducts(result.data);
                } 
            } catch (error) {
                console.error('L·ªói load s·∫£n ph·∫©m:', error);
                alert('L·ªói t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m');
            }
        }

        // Render danh s√°ch s·∫£n ph·∫©m
        function renderProducts(products) {
            const tbody = $('#productTableBody');
            tbody.innerHTML = '';

            products.forEach(product => {
                const row = tbody.insertRow();
                row.onclick = () => fillForm(row, product);
                row.innerHTML = `
            <td>${product.MaPhuTung}</td>
            <td>${product.TenPhuTung}</td>
            <td>${product.TenLoaiXe || product.MaLoaiXe}</td>
            <td>${Utils.formatCurrency(product.GiaBan)}</td>
            <td>${product.MaDanhMuc}</td>
            <td><img src="asset/${product.HinhAnh}" style="width:70px; height:50px; object-fit:cover;" onerror="this.src='asset/car-icon.png'"></td>
            <td class="actions">
                <i class="fas fa-edit edit-icon"></i>
                <i class="fas fa-trash trash-icon" onclick="event.stopPropagation(); deleteRow('${product.MaPhuTung}')"></i>
            </td>
        `;
            });
        }

        // ƒêi·ªÅn d·ªØ li·ªáu l√™n form
        function fillForm(row, product) {
            currentRow = row;
            currentProductId = product.MaPhuTung;
            currentProduct = product; // L∆∞u to√†n b·ªô th√¥ng tin s·∫£n ph·∫©m

            $('#maPhuTung').value = product.MaPhuTung;
            $('#tenPhuTung').value = product.TenPhuTung;
            // S·ª≠ d·ª•ng MaLoaiXe thay v√¨ TenLoaiXe
            $('#loaiXe').value = product.MaLoaiXe;
            $('#gia').value = product.GiaBan;
            // S·ª≠ d·ª•ng MaDanhMuc ƒë√∫ng format
            $('#maDanhMuc').value = product.MaDanhMuc;

            const preview = $('#imgPreview');
            if (product.HinhAnh) {
                preview.src = `asset/${product.HinhAnh}`;
                preview.style.display = 'block';
            }
        }

        // X√≥a s·∫£n ph·∫©m
        async function deleteRow(maPhuTung) {
            if (!confirm('X√≥a s·∫£n ph·∫©m n√†y?')) return;

            try {
                const result = await ProductAPI.delete(maPhuTung);
                if (result.success) {
                    alert('X√≥a th√†nh c√¥ng!');
                    loadProducts();
                    resetForm();
                } 
            } catch (error) {
                console.error('L·ªói x√≥a:', error);
                alert('L·ªói x√≥a s·∫£n ph·∫©m');
            }
        }

        // Reset form
        function resetForm() {
            $('#maPhuTung').value = '';
            $('#tenPhuTung').value = '';
            $('#loaiXe').selectedIndex = 0;
            $('#gia').value = '';
            const maDanhMucSelect = $('#maDanhMuc');
            if (maDanhMucSelect) {
                maDanhMucSelect.selectedIndex = 0;
            }
            const preview = $('#imgPreview');
            preview.src = '';
            preview.style.display = 'none';
            currentRow = null;
            currentProductId = null;
            currentProduct = null;
        }

        // Preview ·∫£nh khi ch·ªçn file
        function previewImage(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = $('#imgPreview');
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            }
        }

        // L·∫•y t√™n file h√¨nh ·∫£nh
        function getImageFileName() {
            const preview = $('#imgPreview');
            if (preview.src.includes('blob:')) {
                // N·∫øu l√† file m·ªõi upload, d√πng t√™n m·∫∑c ƒë·ªãnh ho·∫∑c t√™n file
                const fileInput = $('#fileInput');
                if (fileInput.files.length > 0) {
                    return fileInput.files[0].name;
                }
                return 'default.png';
            }
            // L·∫•y t√™n file t·ª´ URL
            const parts = preview.src.split('/');
            return parts[parts.length - 1] || 'default.png';
        }

        // N√∫t Th√™m
        $('.btn-add').onclick = async function () {
            const btn = $('.btn-add');

            // Prevent double click
            if (btn.disabled) return;

            const maPhuTung = $('#maPhuTung').value.trim();
            const tenPhuTung = $('#tenPhuTung').value.trim();
            const gia = $('#gia').value.trim();
            const maLoaiXe = $('#loaiXe').value;
            // ∆Øu ti√™n l·∫•y maDanhMuc t·ª´ URL (v√¨ dropdown c√≥ th·ªÉ b·ªã disabled)
            const maDanhMuc = getCategoryIdFromURL() || $('#maDanhMuc').value;

            if (!maPhuTung || !tenPhuTung || !gia) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                return;
            }

            if (!maLoaiXe || !maDanhMuc) {
                alert('Vui l√≤ng ch·ªçn lo·∫°i xe v√† danh m·ª•c!');
                return;
            }

            try {
                // Disable button
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

                // T·∫°o FormData thay v√¨ JSON
                const formData = new FormData();
                formData.append('MaPhuTung', maPhuTung);
                formData.append('MaHangXe', 'BMW');
                formData.append('MaLoaiXe', maLoaiXe);
                formData.append('TenPhuTung', tenPhuTung);
                formData.append('GiaBan', parseFloat(gia.toString().replace(/[^\d]/g, '')));
                formData.append('SoLuong', 1);
                formData.append('MoTa', '');
                formData.append('MaDanhMuc', maDanhMuc);
                formData.append('NhaCC', 'Royal Auto');

                // Th√™m file ·∫£nh n·∫øu c√≥
                const fileInput = $('#fileInput');
                if (fileInput.files.length > 0) {
                    formData.append('image', fileInput.files[0]);
                } else {
                    // N·∫øu kh√¥ng c√≥ file, g·ª≠i t√™n ·∫£nh m·∫∑c ƒë·ªãnh ho·∫∑c t·ª´ logic c≈©
                    formData.append('HinhAnh', getImageFileName());
                }

                console.log('üì¶ D·ªØ li·ªáu FormData g·ª≠i ƒëi...');

                const result = await ProductAPI.create(formData);
                if (result.success) {
                    alert('Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!');
                    loadProducts();
                    resetForm();
                } else {
                    // Check loosely for connection/server errors
                    const msg = (result.message || '').toLowerCase();
                    if (msg.includes('l·ªói k·∫øt n·ªëi') || msg.includes('l·ªói server') || msg.includes('connection')) {
                        console.warn('‚ö†Ô∏è Ignored connection error:', result.message);
                        loadProducts(); // Load l·∫°i ƒë·ªÉ ki·ªÉm tra
                        resetForm();
                    }
                }
            } catch (error) {
                console.error('L·ªói th√™m:', error);
                // Suppress network/fetch errors
                const errMsg = (error.message || '').toLowerCase();
                if (errMsg.includes('fetch') || errMsg.includes('network') || errMsg.includes('k·∫øt n·ªëi')) {
                    console.warn('‚ö†Ô∏è Ignored network error in catch block');
                    loadProducts();
                    resetForm();
                } else {
                    alert('L·ªói th√™m s·∫£n ph·∫©m: ' + error.message);
                }
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i> Th√™m';
            }
        };

        // N√∫t C·∫≠p nh·∫≠t
        $('.btn-update').onclick = async function () {
            if (!currentProductId) {
                alert('Vui l√≤ng ch·ªçn m·ªôt s·∫£n ph·∫©m ƒë·ªÉ c·∫≠p nh·∫≠t!');
                return;
            }

            const tenPhuTung = $('#tenPhuTung').value.trim();
            const gia = $('#gia').value.trim();

            if (!tenPhuTung || !gia) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            try {
                // L·∫•y s·ªë l∆∞·ª£ng t·ª´ s·∫£n ph·∫©m hi·ªán t·∫°i ho·∫∑c m·∫∑c ƒë·ªãnh l√† 1
                const soLuong = currentProduct ? (currentProduct.SoLuong || 1) : 1;

                const formData = new FormData();
                formData.append('TenPhuTung', tenPhuTung);
                formData.append('GiaBan', parseFloat(gia.toString().replace(/[^\d]/g, '')));
                formData.append('SoLuong', soLuong);
                formData.append('MoTa', currentProduct ? (currentProduct.MoTa || '') : '');
                formData.append('NhaCC', currentProduct ? (currentProduct.NhaCC || 'Royal Auto') : 'Royal Auto');

                // Th√™m file ·∫£nh n·∫øu c√≥
                const fileInput = $('#fileInput');
                if (fileInput.files.length > 0) {
                    formData.append('image', fileInput.files[0]);
                } else {
                    // Gi·ªØ l·∫°i t√™n ·∫£nh c≈© n·∫øu kh√¥ng upload m·ªõi
                    formData.append('HinhAnh', getImageFileName());
                }

                console.log('üì¶ D·ªØ li·ªáu c·∫≠p nh·∫≠t (FormData)...');

                const result = await ProductAPI.update(currentProductId, formData);
                if (result.success) {
                    alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    loadProducts();
                    resetForm();
                } 
            } catch (error) {
                console.error('L·ªói c·∫≠p nh·∫≠t:', error);
                alert('L·ªói c·∫≠p nh·∫≠t s·∫£n ph·∫©m');
            }
        };

        function goTo(page) {
            window.location.href = page;
        }

        // Load d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', async function () {
            // Load dropdown data tr∆∞·ªõc
            await loadVehicleTypes();
            await loadCategories();
            // Sau ƒë√≥ load th√¥ng tin v√† s·∫£n ph·∫©m
            loadCategoryInfo();
            loadProducts();
        });
    </script>

</body>

</html>