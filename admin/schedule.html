<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTOTECH - Đặt lịch</title>
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="dashboard-body admin-body">

<div class="page-wrapper">

    <!-- Top User -->
    <div class="top-user">
        <span class="username">Administrator</span>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <ul class="menu">
            <li class="menu-item " onclick="goTo('dashboard.html')">
                <i class="fas fa-th-large"></i> Sản phẩm
            </li>
            <li class="menu-item" onclick="goTo('user.html')">
                <i class="fas fa-users"></i> Người dùng
            </li>
            <li class="menu-item" onclick="goTo('order.html')">
                <i class="fas fa-shopping-cart"></i> Đơn hàng
            </li>
            <li class="menu-item active" onclick="goTo('schedule.html')">
                <i class="fas fa-calendar-check"></i> Đặt lịch
            </li>
            <li class="menu-item" onclick="goTo('notifications.html')">
                <i class="fas fa-bell"></i> Thông báo
            </li>
            <li class="menu-item" onclick="goTo('chatbox.html')">
                <i class="fas fa-comments"></i> Chatbox
        </ul>
    </aside>

    <main class="admin-main">
        <section class="panel-grid">

        <!-- BẢNG ĐẶT LỊCH BẢO DƯỠNG -->
        <div class="table-card">
            <h2 class="table-title">Đặt lịch bảo dưỡng định kỳ</h2>
            <div class="table-container">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Mã đơn bảo dưỡng</th>
                            <th>Mã khách hàng</th>
                            <th>Loại xe</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleTableBody">
                        <!-- Dữ liệu sẽ được load từ API -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- FORM CHI TIẾT – NGÀY NHẬN XE KHÔNG CHO SỬA -->
        <div id="scheduleDetailCard" class="detail-card">
            <h2 class="detail-title">Chi tiết</h2>
            <div class="form-grid-schedule">

                <div class="form-group">
                    <label>Mã bảo dưỡng</label>
                    <input type="text" id="maBaoDuong" readonly>
                </div>

                <!-- NGÀY NHẬN XE CHỈ XEM, KHÔNG SỬA -->
                <div class="form-group">
                    <label>Ngày nhận xe</label>
                    <input type="text" id="ngayNhanXe" readonly 
                           style="background:#f8f9fa; color:#212529; font-weight:600; cursor:not-allowed; letter-spacing:0.5px;">
                </div>

                <div class="form-group">
                    <label>Mã khách hàng</label>
                    <input type="text" id="maKH" readonly>
                </div>

                <div class="form-group">
                    <label>Loại xe</label>
                    <input type="text" id="loaiXe" readonly>
                </div>

                <div class="form-group">
                    <label>Tên khách hàng</label>
                    <input type="text" id="tenKH" readonly>
                </div>

                <div class="form-group">
                    <label>Trạng thái</label>
                    <select id="trangThai">
                        <option value="pending">Chưa hoàn thành</option>
                        <option value="completed">Đã hoàn thành</option>
                    </select>
                </div>

            </div>

            <div class="action-buttons">
                <button class="btn-update btn-update-circle" onclick="updateSchedule()">
                    <i class="fas fa-pen"></i> Cập nhật
                </button>
            </div>
        </div>

        </section>
    </main>

    <div class="bottom-brand">
        <div class="brand-name">OTOTECH</div>
        <div class="version">Version: 1.0.0.11</div>
    </div>
</div>

<!-- API Service -->
<script src="asset/api.js"></script>

<script>
// Kiểm tra authentication
if (!AuthService.isAuthenticated()) {
    window.location.href = 'welcome.html';
}

var currentScheduleRow = null;
var currentScheduleId = null;

function $(s) { return document.querySelector(s); }

// Load danh sách lịch bảo dưỡng
async function loadSchedules() {
    try {
        Utils.showLoading($('#scheduleTableBody'));
        const result = await ScheduleAPI.getAll({ limit: 100 });
        
        if (result.success) {
            renderSchedules(result.data);
        } else {
            alert('Lỗi: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi load lịch bảo dưỡng:', error);
        alert('Lỗi tải dữ liệu lịch bảo dưỡng');
    }
}

// Render danh sách lịch bảo dưỡng
function renderSchedules(schedules) {
    const tbody = $('#scheduleTableBody');
    tbody.innerHTML = '';
    
    schedules.forEach(schedule => {
        const row = tbody.insertRow();
        row.onclick = () => fillScheduleForm(row, schedule);
        const statusClass = schedule.TrangThai === 'Đã hoàn thành' ? 'completed' : 'pending';
        const statusText = schedule.TrangThai === 'Đã hoàn thành' ? 'Đã hoàn thành' : 'Chưa hoàn thành';
        
        row.innerHTML = `
            <td>BD${schedule.MaDV.toString().padStart(3, '0')}</td>
            <td>${schedule.MaND}</td>
            <td>${schedule.TenLoaiXe || ''}</td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
        `;
    });
}

async function fillScheduleForm(row, schedule) {
    currentScheduleRow = row;
    currentScheduleId = schedule.MaDV;
    
    const card = document.getElementById('scheduleDetailCard');
    card.style.display = 'block';

    // Load chi tiết
    try {
        const detailResult = await ScheduleAPI.getById(schedule.MaDV);
        if (detailResult.success) {
            const detail = detailResult.data;
            $('#maBaoDuong').value = `BD${detail.MaDV.toString().padStart(3, '0')}`;
            $('#maKH').value = detail.MaND;
            $('#loaiXe').value = detail.TenLoaiXe || '';
            $('#tenKH').value = detail.TenKhachHang || '';
            $('#ngayNhanXe').value = detail.NgayTao ? Utils.formatDate(detail.NgayTao) : '';
            $('#trangThai').value = detail.TrangThai === 'Đã hoàn thành' ? 'completed' : 'pending';
        }
    } catch (error) {
        console.error('Lỗi load chi tiết:', error);
    }

    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

async function updateSchedule() {
    if (!currentScheduleId) return alert('Vui lòng chọn lịch bảo dưỡng!');

    const statusValue = $('#trangThai').value;
    const statusText = statusValue === 'completed' ? 'Đã hoàn thành' : 'Chưa hoàn thành';

    try {
        const result = await ScheduleAPI.updateStatus(currentScheduleId, statusText);
        if (result.success) {
    alert('Cập nhật trạng thái bảo dưỡng thành công!');
            loadSchedules();
        } else {
            alert('Lỗi: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi cập nhật:', error);
        alert('Lỗi cập nhật lịch bảo dưỡng');
    }
}

function goTo(page) {
    window.location.href = page;
}

// Load dữ liệu khi trang được tải
document.addEventListener('DOMContentLoaded', function() {
    loadSchedules();
});
</script>

</body>
</html>