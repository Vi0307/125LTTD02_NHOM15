<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTOTECH - Đơn hàng</title>
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="dashboard-body admin-body">

    <div class="page-wrapper">

        <!-- Top User -->
        <div class="top-user">
            <span class="username">Administrator</span>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="menu">
                <li class="menu-item" onclick="goTo('dashboard.html')">
                    <i class="fas fa-th-large"></i> Sản phẩm
                </li>
                <li class="menu-item" onclick="goTo('user.html')">
                    <i class="fas fa-users"></i> Người dùng
                </li>
                <li class="menu-item active" onclick="goTo('order.html')">
                    <i class="fas fa-shopping-cart"></i> Đơn hàng
                </li>
                <li class="menu-item" onclick="goTo('schedule.html')">
                    <i class="fas fa-calendar-check"></i> Đặt lịch
                </li>
                <li class="menu-item" onclick="goTo('notifications.html')">
                    <i class="fas fa-bell"></i> Thông báo
                </li>
                <li class="menu-item" onclick="goTo('dailymanagement.html')">
                    <i class="fas fa-store"></i> Đại lý
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <section class="panel-grid">

                <!-- BẢNG ĐƠN HÀNG -->
                <div class="table-card">
                    <h2 class="table-title">Đơn Hàng</h2>
                    <div class="table-container">
                        <table class="order-table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Mã đơn hàng</th>
                                    <th>Mã khách hàng</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="orderTableBody">
                                <!-- Dữ liệu sẽ được load từ API -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- FORM CHI TIẾT – HIỆN NGAY DƯỚI BẢNG -->
                <div id="orderDetailCard" class="detail-card">
                    <h2 class="detail-title">Đơn hàng</h2>
                    <div class="form-grid-order">
                        <div class="form-group"><label>Mã đơn hàng</label><input type="text" id="maDonHang" readonly>
                        </div>
                        <div class="form-group"><label>Tổng tiền</label><input type="text" id="tongTien" readonly></div>
                        <div class="form-group"><label>Mã khách hàng</label><input type="text" id="maKhachHang"
                                readonly></div>
                        <div class="form-group"><label>Tên phụ tùng</label><input type="text" id="tenPhuTung" readonly>
                        </div>
                        <div class="form-group"><label>Phương thức thanh toán</label><input type="text"
                                id="phuongThucTT" readonly></div>
                        <div class="form-group"><label>Tên khách hàng</label><input type="text" id="tenKhachHang"
                                readonly></div>
                        <div class="form-group"><label>Địa chỉ</label><input type="text" id="diaChi" readonly></div>
                        <div class="form-group"><label>Vận chuyển</label><input type="text" id="vanChuyen" readonly>
                        </div>
                        <div class="form-group"><label>Voucher</label><input type="text" id="voucher" readonly></div>
                        <div class="form-group">
                            <label>Trạng thái</label>
                            <select id="trangThai">
                                <option value="pending">Đang giao</option>
                                <option value="completed">Đã giao</option>
                                <option value="cancelled">Đã hủy</option>
                            </select>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-update" onclick="updateOrderStatus()">Cập nhật</button>
                    </div>
                </div>

            </section>
        </main>

        <div class="bottom-brand">
            <div class="brand-name">OTOTECH</div>
            <div class="version">Version: 1.0.0.11</div>
        </div>
    </div>

    <!-- API Service -->
    <script src="asset/api.js"></script>

    <script>
        // Kiểm tra authentication
        if (!AuthService.isAuthenticated()) {
            window.location.href = 'welcome.html';
        }

        var currentOrderRow = null;
        var currentOrderId = null;

        function $(selector) { return document.querySelector(selector); }

        // Load danh sách đơn hàng
        async function loadOrders() {
            try {
                Utils.showLoading($('#orderTableBody'));
                const result = await OrderAPI.getAll({ limit: 100 });

                if (result.success) {
                    renderOrders(result.data);
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi load đơn hàng:', error);
                alert('Lỗi tải dữ liệu đơn hàng');
            }
        }

        // Render danh sách đơn hàng
        function renderOrders(orders) {
            const tbody = $('#orderTableBody');
            tbody.innerHTML = '';

            orders.forEach((order, index) => {
                const row = tbody.insertRow();
                row.onclick = () => fillOrderForm(row, order);
                let statusClass = 'pending';
                let statusText = 'Đang giao';
                if (order.TrangThai === 'Đã giao') {
                    statusClass = 'completed';
                    statusText = 'Đã giao';
                } else if (order.TrangThai === 'Đã hủy') {
                    statusClass = 'cancelled';
                    statusText = 'Đã hủy';
                }

                row.innerHTML = `
            <td>${index + 1}</td>
            <td>${order.MaDH}</td>
            <td>${order.MaND}</td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
        `;
            });
        }

        async function fillOrderForm(row, order) {
            currentOrderRow = row;
            currentOrderId = order.MaDH;

            const detailCard = document.getElementById('orderDetailCard');
            detailCard.style.display = 'block';

            // Load chi tiết đơn hàng
            try {
                const detailResult = await OrderAPI.getById(order.MaDH);
                if (detailResult.success) {
                    const orderDetail = detailResult.data;
                    $('#maDonHang').value = orderDetail.MaDH;
                    $('#maKhachHang').value = orderDetail.MaND;
                    $('#tenKhachHang').value = orderDetail.TenKhachHang || '';
                    $('#tongTien').value = Utils.formatCurrency(orderDetail.TongTien);
                    $('#tenPhuTung').value = orderDetail.TenPhuTung || '';
                    $('#diaChi').value = orderDetail.DiaChiGiao || '';
                    $('#phuongThucTT').value = orderDetail.PhuongThucThanhToan || 'Tiền mặt';
                    $('#vanChuyen').value = orderDetail.TenPTVC || 'Giao hàng tiết kiệm';
                    $('#voucher').value = orderDetail.LoaiVoucher || 'Không có';
                    // Set trạng thái
                    if (orderDetail.TrangThai === 'Đã giao') {
                        $('#trangThai').value = 'completed';
                    } else if (orderDetail.TrangThai === 'Đã hủy') {
                        $('#trangThai').value = 'cancelled';
                    } else {
                        $('#trangThai').value = 'pending';
                    }
                }
            } catch (error) {
                console.error('Lỗi load chi tiết:', error);
            }

            detailCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function updateOrderStatus() {
            if (!currentOrderId) {
                alert('Vui lòng chọn đơn hàng trước!');
                return;
            }

            const statusValue = $('#trangThai').value;
            let statusText = 'Đang giao';
            if (statusValue === 'completed') {
                statusText = 'Đã giao';
            } else if (statusValue === 'cancelled') {
                statusText = 'Đã hủy';
            }

            try {
                const result = await OrderAPI.update(currentOrderId, { TrangThai: statusText });
                if (result.success) {
                    alert('Cập nhật trạng thái thành công!');
                    loadOrders();
                } else {
                    alert('Lỗi: ' + result.message);
                }
            } catch (error) {
                console.error('Lỗi cập nhật:', error);
                alert('Lỗi cập nhật đơn hàng');
            }
        }

        function goTo(page) {
            window.location.href = page;
        }

        // Load dữ liệu khi trang được tải
        document.addEventListener('DOMContentLoaded', function () {
            loadOrders();
        });
    </script>
</body>

</html>